{% extends 'app-layout.html.twig' %}

{% block content %}
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center justify-between">
    <div class="flex-auto max-w-2xl text-pretty">
      <h1 class="text-base font-medium text-gray-900">
        Team Details
      </h1>
      <p class="mt-2 text-base text-gray-600">
        View the details of the team. You can edit or delete this team using the
        team options.
      </p>
    </div>

    {# Check if at least one action is allowed #}
    {% set hasTeamActions = is_granted(TEAM_EDIT, team)
      or is_granted(TEAM_DELETE, team)
    %}
    {% if hasTeamActions %}
      <el-dropdown class="dropdown">
        <button class="btn-style-primary btn-size-md w-full">
          Team Options
        </button>
        <el-menu anchor="bottom end" popover class="dropdown-menu">
          <a href="{{
            path(
              'app_team_tasks',
              {
                id: team.id
              }
            )
            }}"
            class="dropdown-item">
            Tasks<span class="sr-only">, {{ team.name }}</span>
          </a>

          {% if is_granted(TEAM_EDIT, team) or is_granted(TEAM_DELETE, team) %}
            <div class="dropdown-separator"></div>
          {% endif %}

          {% if is_granted(TEAM_EDIT, team) %}
            <a href="{{
              path(
                'app_team_edit',
                {
                  id: team.id
                }
              )
              }}"
              class="dropdown-item">
              Edit<span class="sr-only">, {{ team.name }}</span>
            </a>
          {% endif %}
          {% if is_granted(TEAM_DELETE, team) %}
            <button command="show-modal"
              commandfor="delete-dialog-{{ team.id }}"
              class="dropdown-item-destructive">
              Delete<span class="sr-only">, {{ team.name }}</span>
            </button>
          {% endif %}
        </el-menu>
      </el-dropdown>
    {% endif %}
  </div>

  <div class="mt-8">
    <div class="mt-6 border-t border-gray-200">
      <dl class="divide-y divide-gray-200">
        <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
          <dt class="text-sm/6 font-medium text-gray-900">
            Name
          </dt>
          <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
            {{ team.name }}
          </dd>
        </div>

        <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
          <dt class="text-sm/6 font-medium text-gray-900">
            Description
          </dt>
          <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
            {% if team.description %}
              {{ team.description|nl2br }}
            {% else %}
              <span class="text-gray-400">No description provided</span>
            {% endif %}
          </dd>
        </div>

        <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
          <dt class="text-sm/6 font-medium text-gray-900">
            Owner
          </dt>
          <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
            {{ team.createdBy.firstName }} {{ team.createdBy.lastName }}
            <span class="text-gray-400">({{ team.createdBy.email }})</span>
          </dd>
        </div>

        <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
          <dt class="text-sm/6 font-medium text-gray-900">
            Members
          </dt>
          <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
            {% set filteredMembers = [] %}
            {% for member in team.users %}
              {% if member.id != team.createdBy.id %}
                {% set filteredMembers = filteredMembers|merge([member]) %}
              {% endif %}
            {% endfor %}

            {% if (filteredMembers|length) > 0 %}
              <ul class="list-disc pl-4">
                {% for member in filteredMembers %}
                  <li>
                    {{ member.firstName }} {{ member.lastName }}
                    <span class="text-gray-400">({{ member.email }})</span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-gray-400">No additional members</span>
            {% endif %}
          </dd>
        </div>

        <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
          <dt class="text-sm/6 font-medium text-gray-900">
            Created at
          </dt>
          <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
            {{ team.createdAt|date('F j, Y, g:i a') }}
          </dd>
        </div>

        <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
          <dt class="text-sm/6 font-medium text-gray-900">
            Last updated
          </dt>
          <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
            {{ team.updatedAt|date('F j, Y, g:i a') }}
          </dd>
        </div>
      </dl>
    </div>

    {# Pending Join Requests Section (only for team owner/allowed users) #}
    {% if is_granted(TEAM_VIEW_REQUESTS, team) %}
      <div class="mt-10">
        <h2 class="text-base font-medium text-gray-700 mb-3">
          Pending Join Requests
        </h2>
        {% set pendingJoinRequests = team.pendingJoinRequests %}
        {% if (pendingJoinRequests|length) > 0 %}
          <ul class="divide-y divide-gray-200">
            {% for request in pendingJoinRequests %}
              <li class="py-2 flex items-center justify-between">
                <span>
                  {{ request.requester.firstName }}
                  {{ request.requester.lastName }}
                  <span class="text-gray-400 text-xs ml-2">
                    {{ request.createdAt|ago }}
                  </span>
                </span>
                <div class="flex gap-2">
                  <form method="POST"
                    action="{{
                    path(
                      'app_join_request_decline',
                      {
                        id: request.id
                      }
                    )
                    }}">
                    <button type="submit" class="btn-style-ghost btn-size-md">
                      Decline
                    </button>
                  </form>
                  <form method="POST"
                    action="{{
                    path(
                      'app_join_request_accept',
                      {
                        id: request.id
                      }
                    )
                    }}">
                    <button type="submit" class="btn-style-primary btn-size-md">
                      Accept
                    </button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="focusable cursor-pointer relative w-full rounded-lg border-1 border-dashed border-gray-400 p-12 flex flex-col items-center text-center">
            <svg xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1"
              stroke="currentColor"
              class="mx-auto size-12 text-gray-400">
              <path stroke-linecap="round"
                stroke-linejoin="round"
                d="M18 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0ZM3 19.235v-.11a6.375 6.375 0 0 1 12.75 0v.109A12.318 12.318 0 0 1 9.374 21c-2.331 0-4.512-.645-6.374-1.766Z" />
            </svg>

            <span class="mt-2 block text-sm font-medium text-gray-600">
              No pending join requests
            </span>
            <span class="mt-1 block text-sm text-gray-400 max-w-sm text-pretty">
              You will be notified here when users request to join your team.
            </span>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {# Delete Confirmation Modal - only render if user can delete #}
  {% if is_granted(TEAM_DELETE, team) %}
    <el-dialog>
      <dialog id="delete-dialog-{{ team.id }}"
        aria-labelledby="dialog-title-{{ team.id }}"
        class="fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent">
        <el-dialog-backdrop class="backdrop"></el-dialog-backdrop>
        <div tabindex="0"
          class="flex min-h-full items-end justify-center p-4 text-center focus:outline-none sm:items-center sm:p-0">
          <el-dialog-panel class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-200 data-enter:ease-out data-leave:duration-100 data-leave:ease-in sm:my-8 sm:w-full sm:max-w-lg data-closed:sm:translate-y-0 data-closed:sm:scale-95">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
              <div class="sm:flex sm:items-start">
                <div class="mx-auto flex size-12 shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:size-10">
                  <svg viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    data-slot="icon"
                    aria-hidden="true"
                    class="size-6 text-red-600">
                    <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                      stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                  <h3 id="dialog-title-{{ team.id }}"
                    class="text-base font-medium text-gray-900">
                    Delete Team
                  </h3>
                  <div class="mt-2">
                    <p class="text-sm text-gray-600">
                      Are you sure you want to delete "{{ team.name }}"? This
                      action cannot be undone and will remove all team members.
                    </p>
                  </div>
                </div>
              </div>
            </div>
            <div class="border-t border-gray-200 px-4 py-3 flex flex-col justify-end sm:flex-row sm:px-6 gap-2">
              <button type="button"
                autofocus
                command="close"
                commandfor="delete-dialog-{{ team.id }}"
                class="btn-style-ghost btn-size-md">
                Cancel
              </button>
              <form method="POST"
                action="{{
                path(
                  'app_team_delete',
                  {
                    id: team.id
                  }
                )
                }}">
                <input type="hidden"
                  name="_token"
                  value="{{ csrf_token('delete_team_' ~ team.id) }}" />
                <button type="submit"
                  class="btn-style-destructive btn-size-md w-full">
                  Delete
                </button>
              </form>
            </div>
          </el-dialog-panel>
        </div>
      </dialog>
    </el-dialog>
  {% endif %}
{% endblock %}
