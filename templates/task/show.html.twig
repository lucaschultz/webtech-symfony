{% extends 'app-layout.html.twig' %}

{% form_theme commentForm 'form/tailwind_custom.html.twig' %}

{% block content %}
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center justify-between">
    <div class="flex-auto max-w-2xl text-pretty">
      <h1 class="font-medium">
        Task Details
      </h1>
      <p class="mt-2 text-base text-gray-600">
        View the details of the task. You can edit or delete this task using the
        task options.
      </p>
    </div>

    <el-dropdown class="dropdown">
      <button class="btn-style-primary btn-size-md w-full">Task Options</button>
      <el-menu anchor="bottom end" popover class="dropdown-menu">
        <a href="{{
          path(
            'app_task_update',
            {
              taskId: task.id,
              redirectTo: app.request.uri
            }
          )
          }}"
          class="dropdown-item">
          Edit<span class="sr-only">, {{ task.title }}</span>
        </a>
        <button command="show-modal"
          commandfor="delete-dialog-{{ task.id }}"
          class="dropdown-item-destructive">
          Delete<span class="sr-only">, {{ task.title }}</span>
        </button>
      </el-menu>
    </el-dropdown>
  </div>

  <div class="border-t mt-12 border-gray-200">
    <dl class="divide-y divide-gray-200">
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Title
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          {{ task.title }}
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Description
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          {% if task.description %}
            {{ task.description|nl2br }}
          {% else %}
            <span class="text-gray-400">No description provided</span>
          {% endif %}
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Status
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          <el-dropdown class="dropdown">
            {% set statusColors = {
              TODO: 'text-gray-600 ring-gray-500/10',
              IN_PROGRESS: 'bg-blue-50 text-blue-700 ring-blue-600/20',
              DONE: 'bg-green-50 text-green-700 ring-green-600/20'
            } %}
            <button class="inline-flex whitespace-nowrap cursor-pointer items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 {{
              statusColors[task.status.value]
              }}">
              {{ task.status.value == 'TODO'
                ? 'To Do'
                : task.status.value == 'IN_PROGRESS' ? 'In Progress' : 'Done' }}
            </button>
            <el-menu anchor="bottom start" popover class="dropdown-menu">
              <form method="POST"
                class="inline"
                action="{{
                path(
                  'app_task_status',
                  {
                    taskId: task.id,
                    status: 'TODO',
                    redirectTo: app.request.uri
                  }
                )
                }}">
                <button type="submit" class="dropdown-item">To Do</button>
              </form>
              <form method="POST"
                class="inline"
                action="{{
                path(
                  'app_task_status',
                  {
                    taskId: task.id,
                    status: 'IN_PROGRESS',
                    redirectTo: app.request.uri
                  }
                )
                }}">
                <button type="submit" class="dropdown-item">In Progress</button>
              </form>
              <form method="POST"
                class="inline"
                action="{{
                path(
                  'app_task_status',
                  {
                    taskId: task.id,
                    status: 'DONE',
                    redirectTo: app.request.uri
                  }
                )
                }}">
                <button type="submit" class="dropdown-item">Done</button>
              </form>
            </el-menu>
          </el-dropdown>
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Priority
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          <el-dropdown class="dropdown">
            <button class="inline-flex whitespace-nowrap cursor-pointer items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 text-gray-600 ring-gray-500/10">
              {{ task.priority.value == 'HIGH'
                ? 'High'
                : task.priority.value == 'MEDIUM' ? 'Medium' : 'Low' }}
            </button>
            <el-menu anchor="bottom start" popover class="dropdown-menu">
              <form method="POST"
                class="inline"
                action="{{
                path(
                  'app_task_priority',
                  {
                    taskId: task.id,
                    priority: 'HIGH',
                    redirectTo: app.request.uri
                  }
                )
                }}">
                <button type="submit" class="dropdown-item">High</button>
              </form>
              <form method="POST"
                class="inline"
                action="{{
                path(
                  'app_task_priority',
                  {
                    taskId: task.id,
                    priority: 'MEDIUM',
                    redirectTo: app.request.uri
                  }
                )
                }}">
                <button type="submit" class="dropdown-item">Medium</button>
              </form>
              <form method="POST"
                class="inline w-full"
                action="{{
                path(
                  'app_task_priority',
                  {
                    taskId: task.id,
                    priority: 'LOW',
                    redirectTo: app.request.uri
                  }
                )
                }}">
                <button type="submit" class="dropdown-item">Low</button>
              </form>
            </el-menu>
          </el-dropdown>
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Team
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          {{ task.team.name }}
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Created by
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          {{ task.createdBy.firstName }} {{ task.createdBy.lastName }}
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Assigned to
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          {% if task.assignedTo %}
            {{ task.assignedTo.firstName }} {{ task.assignedTo.lastName }}
          {% else %}
            <span class="text-gray-400">Not assigned</span>
          {% endif %}
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Deadline
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          {% if task.deadline %}
            {{ task.deadline|date('F j, Y, g:i a') }}
          {% else %}
            <span class="text-gray-400">No deadline</span>
          {% endif %}
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Created at
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          {{ task.createdAt|date('F j, Y, g:i a') }}
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="text-sm/6 font-medium text-gray-900">
          Last updated
        </dt>
        <dd class="mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0">
          {{ task.updatedAt|date('F j, Y, g:i a') }}
        </dd>
      </div>
    </dl>
  </div>

  <div id="comments" class="mt-12 space-y-2">
    <h2 class="font-medium text-gray-700">
      Comments
    </h2>

    {% if task.comments is empty %}
      <button command="show-modal"
        commandfor="comment-dialog"
        class="focusable cursor-pointer relative w-full rounded-lg border-1 border-dashed border-gray-400 p-12 flex flex-col items-center text-center hover:border-gray-500 hover:bg-gray-100">
        <svg xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1"
          stroke="currentColor"
          class="mx-auto size-12 text-gray-400">
          <path stroke-linecap="round"
            stroke-linejoin="round"
            d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 0 1 .865-.501 48.172 48.172 0 0 0 3.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0 0 12 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018Z" />
        </svg>

        <span class="mt-2 block text-sm font-medium text-gray-600">
          No comments yet
        </span>
        <span class="mt-1 block text-sm text-gray-400 max-w-sm text-pretty">
          Be the first to comment on this task.
        </span>
      </button>
    {% else %}
      <ul class="divide-y divide-gray-200">
        {% for comment in task.comments %}
          <li id="comment-{{ comment.id }}" class="py-6">
            <div class="flex items-baseline text-sm text-gray-700 mb-1">
              <span class="font-medium">
                {{ comment.author.firstName ~ ' ' ~ comment.author.lastName }}
              </span>
              <span class="ml-3 text-gray-400 text-xs">
                {{ comment.createdAt|ago }}
              </span>
            </div>
            <div class="text-base text-pretty">
              {{ comment.content|e }}
            </div>
          </li>
        {% endfor %}
      </ul>
      <button command="show-modal"
        commandfor="comment-dialog"
        class="btn-style-ghost btn-size-md w-full">
        Add Comment
      </button>
    {% endif %}

    <el-dialog>
      <dialog id="delete-dialog-{{ task.id }}"
        aria-labelledby="dialog-title-{{ task.id }}"
        class="fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent">
        <el-dialog-backdrop class="backdrop"></el-dialog-backdrop>
        <div tabindex="0"
          class="flex min-h-full items-end justify-center p-4 text-center focus:outline-none sm:items-center sm:p-0">
          <el-dialog-panel class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-200 data-enter:ease-out data-leave:duration-100 data-leave:ease-in sm:my-8 sm:w-full sm:max-w-lg data-closed:sm:translate-y-0 data-closed:sm:scale-95">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
              <div class="sm:flex sm:items-start">
                <div class="mx-auto flex size-12 shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:size-10">
                  <svg viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    data-slot="icon"
                    aria-hidden="true"
                    class="size-6 text-red-600">
                    <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"
                      stroke-linecap="round"
                      stroke-linejoin="round" />
                  </svg>
                </div>
                <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                  <h3 id="dialog-title-{{ task.id }}"
                    class="text-base font-medium">
                    Delete Task
                  </h3>
                  <div class="mt-2">
                    <p class="text-gray-600">
                      Are you sure you want to delete "{{ task.title }}"? This
                      action cannot be undone and will remove all team members.
                    </p>
                  </div>
                </div>
              </div>
            </div>
            <div class="border-t border-gray-200 px-4 py-3 flex flex-col justify-end sm:flex-row sm:px-6 gap-2">
              <button type="button"
                autofocus
                command="close"
                commandfor="delete-dialog-{{ task.id }}"
                class="btn-style-ghost btn-size-md">
                Cancel
              </button>
              <form method="POST"
                action="{{
                path(
                  'app_team_delete',
                  {
                    id: task.id
                  }
                )
                }}">
                <input type="hidden"
                  name="_token"
                  value="{{ csrf_token('delete_team_' ~ task.id) }}" />
                <button type="submit"
                  class="btn-style-destructive btn-size-md w-full">
                  Delete
                </button>
              </form>
            </div>
          </el-dialog-panel>
        </div>
      </dialog>
    </el-dialog>

    <el-dialog>
      <dialog id="comment-dialog"
        aria-labelledby="comment-dialog-title"
        class="fixed inset-0 size-auto max-h-none max-w-none overflow-y-auto bg-transparent backdrop:bg-transparent">
        <el-dialog-backdrop class="backdrop"></el-dialog-backdrop>
        <div tabindex="0"
          class="flex min-h-full items-end justify-center p-4 text-center focus:outline-none sm:items-center sm:p-0">
          <el-dialog-panel class="relative transform overflow-hidden w-full rounded-lg bg-white text-left shadow-xl transition-all data-closed:translate-y-4 data-closed:opacity-0 data-enter:duration-200 data-enter:ease-out data-leave:duration-100 data-leave:ease-in sm:my-8 sm:w-full sm:max-w-lg data-closed:sm:translate-y-0 data-closed:sm:scale-95">
            {{ form_start(commentForm) }}
            <div class="px-3 py-4 sm:px-4 sm:py-6">
              <div class="text-center sm:text-left">
                <h3 id="dialog-title-{{ task.id }}"
                  class="text-base font-medium">
                  Add Comment
                </h3>
                <div class="mt-2">
                  {{ form_widget(commentForm.content) }}
                  {{ form_errors(commentForm.content) }}
                </div>
              </div>
            </div>
            <div class="border-t border-gray-200 px-4 py-3 flex flex-col justify-end sm:flex-row sm:px-6 gap-2">
              <button type="button"
                autofocus
                command="close"
                commandfor="comment-dialog"
                class="btn-style-ghost btn-size-md">
                Cancel
              </button>
              <button type="submit" class="btn-style-primary btn-size-md">
                Add Comment
              </button>
            </div>
            {{ form_end(commentForm) }}
          </el-dialog-panel>
        </div>
      </dialog>
    </el-dialog>
  </div>
{% endblock %}
